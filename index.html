<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IT Asset Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { card: '#0B1220', ink: '#0f172a' }
        }
      }
    }
  </script>
  <style>
    html { scroll-behavior: smooth; }
    .focus-ring:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,.65); }
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-3xl md:text-4xl font-semibold tracking-tight">IT Asset Tracker</h1>
        <p class="text-slate-400 mt-1">Track laptops, mobiles & tablets • Alerts • Smart Assistant • CSV import</p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <!-- Auto-refresh control -->
        <div class="flex items-center gap-2 bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2">
          <label for="refreshInterval" class="text-sm text-slate-300">Auto-refresh</label>
          <select id="refreshInterval" class="bg-transparent text-sm focus-ring">
            <option value="0">Off</option>
            <option value="5">Every 5s</option>
            <option value="10">Every 10s</option>
            <option value="30">Every 30s</option>
            <option value="60">Every 60s</option>
          </select>
        </div>
        <!-- Demo data -->
        <div class="flex items-center gap-2 bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2">
          <label for="demoCount" class="text-sm text-slate-300">Add demo</label>
          <input id="demoCount" type="number" min="1" value="5" class="w-16 bg-transparent text-sm border border-slate-700 rounded-lg px-2 py-1 focus-ring" />
          <button id="addDemoBtn" class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm">Add</button>
        </div>
        <!-- CSV upload -->
        <div class="flex items-center gap-2 bg-slate-800/60 border border-slate-700 rounded-xl px-3 py-2">
          <input id="csvInput" type="file" accept=".csv" class="hidden" />
          <button id="uploadCsvBtn" class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-sm">Upload CSV</button>
        </div>
        <!-- Export / Reset -->
        <button id="exportBtn" class="px-3 py-2 bg-slate-800/60 border border-slate-700 rounded-xl text-sm hover:bg-slate-800">Export JSON</button>
        <button id="resetBtn" class="px-3 py-2 bg-rose-600/90 hover:bg-rose-600 rounded-xl text-sm">Reset Data</button>
      </div>
    </header>

    <!-- Import banner -->
    <div id="importBanner" class="hidden mb-4 rounded-xl border p-3 bg-slate-900 border-slate-700">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div id="importSummary" class="font-medium"></div>
          <details id="importErrors" class="mt-2">
            <summary class="cursor-pointer text-sm text-slate-300 flex items-center gap-2"><span class="inline-block w-4 h-4 border border-slate-600 rounded">+</span> Show errors</summary>
            <ul id="importErrorList" class="mt-2 text-sm text-slate-400 list-disc pl-5 space-y-1"></ul>
          </details>
        </div>
        <button id="dismissBanner" class="text-xs px-2 py-1 rounded-md border border-slate-700 hover:bg-slate-800">Dismiss</button>
      </div>
    </div>

    <!-- Summary Bar -->
    <section id="summary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3 mb-6"></section>

    <!-- Main Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Cards -->
      <section class="lg:col-span-2">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-xl font-semibold">Assets</h2>
          <div class="flex items-center gap-2">
            <input id="search" placeholder="Search by ID, user, or type…" class="bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2 text-sm focus-ring w-60" />
            <select id="filterStatus" class="bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2 text-sm focus-ring">
              <option value="">All statuses</option>
              <option>provisioned</option>
              <option>assigned</option>
              <option>up-for-replacement</option>
              <option>retired</option>
            </select>
            <select id="filterType" class="bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2 text-sm focus-ring">
              <option value="">All types</option>
              <option>laptop</option>
              <option>mobile</option>
              <option>tablet</option>
            </select>
          </div>
        </div>
        <div id="assetGrid" class="grid sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      </section>

      <!-- Sidebar: Alerts + Assistant -->
      <aside class="space-y-6">
        <section class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold">Alerts</h3>
            <span id="alertCount" class="text-xs text-slate-400"></span>
          </div>
          <ul id="alerts" class="space-y-3"></ul>
        </section>
        <section class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Smart Assistant</h3>
            <button id="regenAssist" class="text-xs px-2 py-1 rounded-md border border-slate-700 hover:bg-slate-800">Regenerate</button>
          </div>
          <div id="assistant" class="space-y-3"></div>
        </section>
        <details class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
          <summary class="text-sm text-slate-300 cursor-pointer">Dev: CSV parser self-tests</summary>
          <div class="mt-3 text-sm">
            <button id="runTestsBtn" class="px-3 py-1.5 bg-slate-800 border border-slate-700 rounded-lg">Run tests (console)</button>
            <p class="text-slate-400 mt-2">Results are printed to the browser console.</p>
          </div>
        </details>
      </aside>
    </div>
  </div>

  <!-- Modal -->
  <dialog id="modal" class="rounded-2xl p-0 bg-slate-900 text-slate-100 border border-slate-700 w-[32rem] max-w-[calc(100vw-2rem)]">
    <div class="p-4 border-b border-slate-800"><h4 id="modalTitle" class="font-semibold"></h4></div>
    <div class="p-4 space-y-3" id="modalBody"></div>
    <div class="p-4 border-t border-slate-800 flex justify-end gap-2">
      <button id="modalCancel" class="px-3 py-2 rounded-lg border border-slate-700 hover:bg-slate-800">Cancel</button>
      <button id="modalOk" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500">OK</button>
    </div>
  </dialog>

  <template id="alertItemTpl">
    <li class="bg-slate-800/60 border border-slate-700 rounded-xl p-3">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-sm font-medium"></p>
          <p class="text-xs text-slate-400 mt-1"></p>
        </div>
        <button class="text-xs px-2 py-1 rounded-md border border-slate-700 hover:bg-slate-800">Resolve</button>
      </div>
    </li>
  </template>

  <script>
    // ---------- Data Model ----------
    const state = { assets: [], alerts: [], timers: { refresh: null }, search: '', filterStatus: '', filterType: '' };
    const TYPES = ['laptop','mobile','tablet'];
    const STATUSES = ['provisioned','assigned','up-for-replacement','retired'];

    const randChoice = arr => arr[Math.floor(Math.random()*arr.length)];
    const randInt = (min,max)=> Math.floor(Math.random()*(max-min+1))+min;
    const nowISO = ()=> new Date().toISOString();
    const daysAgo = n=>{ const d=new Date(); d.setDate(d.getDate()-n); return d.toISOString(); };
    const formatTs = ts => new Date(ts).toLocaleString();
    const newId = ()=> 'AST-'+Math.random().toString(36).slice(2,8).toUpperCase();

    function randomAsset(){
      const type = randChoice(TYPES); const assigned = Math.random()>0.5; const ageDays = randInt(10,1500);
      const upToDate = Math.random()>0.6 ? false : true; const patchApplied = Math.random()>0.5; const flaggedReplacement = Math.random()>0.85; const retired = Math.random()>0.95;
      return { id:newId(), type, status: retired? 'retired' : (flaggedReplacement? 'up-for-replacement' : (assigned? 'assigned':'provisioned')), patch: patchApplied? 'applied':'pending', os: upToDate? 'up-to-date':'pending', user: assigned? randChoice(['alex.fernandez','priya.k','samir.p','meera.s','anita.r','john.d']) : '', lastUpdated: daysAgo(randInt(0,14)), lastActive: daysAgo(randInt(0,120)), ageDays };
    }

    // ---------- Persistence ----------
    const STORAGE_KEY = 'it-asset-tracker-v1';
    const save = ()=>{ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.assets)); }catch{} };
    const load = ()=>{ try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw) state.assets=JSON.parse(raw); }catch{} };

    // ---------- Rendering ----------
    function render(){ renderSummary(); renderAssets(); regenerateAlerts(); renderAssistant(); save(); }

    function renderSummary(){
      const el = document.getElementById('summary');
      const total = state.assets.length;
      const byType = TYPES.reduce((acc,t)=> (acc[t]=state.assets.filter(a=>a.type===t).length, acc), {});
      const upForReplacement = state.assets.filter(a=>a.status==='up-for-replacement').length;
      const pendingPatches = state.assets.filter(a=>a.patch==='pending' && a.status!=='retired').length;
      const pendingOS = state.assets.filter(a=>a.os==='pending' && a.status!=='retired').length;
      const card = (title,val,sub='')=>`<div class="bg-slate-900 border border-slate-800 rounded-2xl p-4"><div class="text-sm text-slate-400">${title}</div><div class="text-2xl font-semibold">${val}</div>${sub?`<div class='text-xs text-slate-400 mt-1'>${sub}</div>`:''}</div>`;
      el.innerHTML = [
        card('Total assets', total, `${byType.laptop||0} laptop • ${byType.mobile||0} mobile • ${byType.tablet||0} tablet`),
        card('By type: Laptops', byType.laptop||0),
        card('By type: Mobiles', byType.mobile||0),
        card('By type: Tablets', byType.tablet||0),
        card('Up for replacement', upForReplacement),
        card('Pending: Patches / OS', `${pendingPatches} / ${pendingOS}`)
      ].join('');
    }

    function pill(text,tone){ const tones={ ok:'bg-emerald-500/10 text-emerald-300 border-emerald-600/40', warn:'bg-amber-500/10 text-amber-300 border-amber-600/40', bad:'bg-rose-500/10 text-rose-300 border-rose-600/40', info:'bg-sky-500/10 text-sky-300 border-sky-600/40', mute:'bg-slate-600/20 text-slate-300 border-slate-600/30' }; return `<span class="px-2 py-0.5 text-[11px] border rounded-full ${tones[tone]||tones.mute}">${text}</span>` }

    function assetCardHTML(a){
      const statusTone={assigned:'info',provisioned:'warn','up-for-replacement':'bad',retired:'mute'}[a.status]||'mute';
      const patchTone=a.patch==='applied'?'ok':'warn'; const osTone=a.os==='up-to-date'?'ok':'bad';
      const actions=[];
      if(a.status!=='retired'){
        actions.push(`<button data-act="assign" class="px-2 py-1 text-xs rounded-lg border border-slate-700 hover:bg-slate-800">${a.user? 'Unassign':'Assign'}</button>`);
        actions.push(`<button data-act="patch" class="px-2 py-1 text-xs rounded-lg border border-slate-700 hover:bg-slate-800">Mark Patch ${a.patch==='pending'?'Applied':'Pending'}</button>`);
        actions.push(`<button data-act="flag" class="px-2 py-1 text-xs rounded-lg border border-amber-700 text-amber-300 hover:bg-amber-950/40">${a.status==='up-for-replacement'?'Unflag':'Flag Replacement'}</button>`);
        actions.push(`<button data-act="retire" class="px-2 py-1 text-xs rounded-lg border border-rose-700 text-rose-300 hover:bg-rose-950/40">Retire</button>`);
      } else {
        actions.push(`<button data-act="restore" class="px-2 py-1 text-xs rounded-lg border border-emerald-700 text-emerald-300 hover:bg-emerald-950/40">Restore</button>`);
      }
      return `
      <article class="bg-card border border-slate-800 rounded-2xl p-4 flex flex-col gap-3">
        <div class="flex items-start justify-between gap-3">
          <div><div class="text-xs text-slate-400">Asset</div><div class="font-semibold tracking-tight">${a.id}</div></div>
          <div class="flex gap-2 flex-wrap justify-end">${pill(a.type,'info')}${pill(a.status,statusTone)}${pill('Patch: '+a.patch,patchTone)}${pill('OS: '+a.os,osTone)}</div>
        </div>
        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
          <div class="text-slate-400">Assigned user</div><div>${a.user||'<span class=\'text-slate-500\'>—</span>'}</div>
          <div class="text-slate-400">Age</div><div>${a.ageDays} days</div>
          <div class="text-slate-400">Last active</div><div>${formatTs(a.lastActive)}</div>
          <div class="text-slate-400">Last updated</div><div>${formatTs(a.lastUpdated)}</div>
        </div>
        <div class="flex flex-wrap gap-2 pt-2 border-t border-slate-800">${actions.join('')}</div>
      </article>`;
    }

    function renderAssets(){
      const grid=document.getElementById('assetGrid'); const q=state.search.toLowerCase();
      const items=state.assets.filter(a=>{ const okQ=!q||a.id.toLowerCase().includes(q)||(a.user||'').toLowerCase().includes(q)||a.type.includes(q); const okS=!state.filterStatus||a.status===state.filterStatus; const okT=!state.filterType||a.type===state.filterType; return okQ&&okS&&okT; });
      grid.innerHTML=items.map(assetCardHTML).join('')||`<div class='text-slate-400'>No assets match your filters.</div>`;
      items.forEach(a=>attachCardHandlers(a.id));
    }

    function attachCardHandlers(id){ const card=[...document.querySelectorAll('#assetGrid article')].find(el=>el.querySelector('.font-semibold').textContent===id); if(!card) return; card.querySelectorAll('button[data-act]').forEach(btn=>btn.addEventListener('click',()=>handleAction(id,btn.getAttribute('data-act')))); }

    function handleAction(id,act){ const a=state.assets.find(x=>x.id===id); if(!a) return; if(act==='assign'){ if(a.user){ a.user=''; a.status='provisioned'; } else { promptModal(`Assign ${a.id}`,'Enter username to assign:',a.user,(val)=>{ if(val){ a.user=val; a.status='assigned'; a.lastActive=nowISO(); } a.lastUpdated=nowISO(); render(); }); return; } } if(act==='patch'){ a.patch=(a.patch==='pending')?'applied':'pending'; } if(act==='flag'){ a.status=(a.status==='up-for-replacement')?(a.user?'assigned':'provisioned'):'up-for-replacement'; } if(act==='retire'){ a.status='retired'; a.user=''; } if(act==='restore'){ a.status='provisioned'; } a.lastUpdated=nowISO(); render(); }

    // ---------- Alerts ----------
    function regenerateAlerts(){
      const alerts=[]; const now=Date.now();
      state.assets.forEach(a=>{
        const daysSinceUpdate=Math.round((now-new Date(a.lastUpdated).getTime())/86400000);
        if(a.os==='pending'&&a.status!=='retired'){
          const sev=daysSinceUpdate>14?'High':'Medium';
          alerts.push({ id:`os-${a.id}`, text:`${a.id}: OS update pending`, rationale:`${sev} priority • last update ${daysSinceUpdate} days ago`, resolve:()=>{ a.os='up-to-date'; a.lastUpdated=nowISO(); render(); } });
        }
        const idleDays=Math.round((now-new Date(a.lastActive).getTime())/86400000);
        if(!a.user&&a.status!=='retired'&&idleDays>30){ alerts.push({ id:`idle-${a.id}`, text:`${a.id}: Unassigned and idle`, rationale:`Idle for ${idleDays} days • consider reassigning or retiring`, resolve:()=>{ a.lastActive=nowISO(); render(); } }); }
        if(a.status==='up-for-replacement'){ alerts.push({ id:`rep-${a.id}`, text:`${a.id}: Flagged for replacement`, rationale:`Asset age ${a.ageDays} days • plan procurement`, resolve:()=>{ a.status=a.user?'assigned':'provisioned'; a.lastUpdated=nowISO(); render(); } }); }
      });
      state.alerts=alerts; const ul=document.getElementById('alerts'); const count=document.getElementById('alertCount'); count.textContent=`${alerts.length} issues`;
      ul.innerHTML=''; const tpl=document.getElementById('alertItemTpl'); alerts.forEach(al=>{ const li=tpl.content.cloneNode(true); li.querySelector('p.text-sm').textContent=al.text; li.querySelector('p.text-xs').textContent=al.rationale; li.querySelector('button').addEventListener('click',()=>al.resolve()); ul.appendChild(li); });
    }

    // ---------- Smart Assistant ----------
    function renderAssistant(){
      const wrap=document.getElementById('assistant'); wrap.innerHTML='';
      const pendingOS=state.assets.filter(a=>a.os==='pending'&&a.status!=='retired');
      const idle=state.assets.filter(a=>!a.user&&a.status!=='retired'&&(Date.now()-new Date(a.lastActive))/86400000>30);
      const replacements=state.assets.filter(a=>a.status==='up-for-replacement');
      const suggestions=[];
      if(pendingOS.length){ suggestions.push({ title:`Bulk update OS on ${pendingOS.length} device(s)`, detail:'Bring all devices to up-to-date. Marks OS as updated and refreshes timestamps.', action:()=>{ pendingOS.forEach(a=>{ a.os='up-to-date'; a.lastUpdated=nowISO(); }); render(); } }); }
      if(idle.length){ suggestions.push({ title:`Review ${idle.length} idle unassigned device(s)`, detail:'Assign to users or retire to reduce unused inventory.', action:()=>{ promptModal('Assign idle devices','Enter username to assign to all idle devices (leave empty to just update last active):','', (val)=>{ idle.forEach(a=>{ if(val){ a.user=val; a.status='assigned'; a.lastActive=nowISO(); } else { a.lastActive=nowISO(); } a.lastUpdated=nowISO(); }); render(); }); } }); }
      if(replacements.length){ suggestions.push({ title:`Schedule replacement for ${replacements.length} asset(s)`, detail:'Moves flagged devices to retired state and clears assignments.', action:()=>{ replacements.forEach(a=>{ a.status='retired'; a.user=''; a.lastUpdated=nowISO(); }); render(); } }); }
      if(!suggestions.length){ suggestions.push({ title:'All good!', detail:'No immediate actions suggested. Check again after the next refresh.' }); }
      suggestions.forEach(s=>{ const card=document.createElement('div'); card.className='bg-slate-800/60 border border-slate-700 rounded-xl p-3'; card.innerHTML=`<div class="font-medium">${s.title}</div><div class="text-sm text-slate-400 mt-1">${s.detail}</div>${s.action?'<div class="mt-2"><button class="px-3 py-1.5 text-xs rounded-lg bg-indigo-600 hover:bg-indigo-500">Apply</button></div>':''}`; if(s.action){ card.querySelector('button')?.addEventListener('click',s.action); } wrap.appendChild(card); });
    }

    // ---------- Modal ----------
    function promptModal(title,label,value,onOk){ const dlg=document.getElementById('modal'); document.getElementById('modalTitle').textContent=title; const body=document.getElementById('modalBody'); body.innerHTML=`<label class="block text-sm text-slate-300 mb-1">${label}</label><input id=\"modalInput\" value=\"${value||''}\" class=\"w-full bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2 text-sm focus-ring\" />`; const ok=document.getElementById('modalOk'); const cancel=document.getElementById('modalCancel'); const cleanup=()=>{ ok.replaceWith(ok.cloneNode(true)); cancel.replaceWith(cancel.cloneNode(true)); }; ok.addEventListener('click',()=>{ const v=document.getElementById('modalInput').value.trim(); dlg.close(); cleanup(); onOk&&onOk(v); }); cancel.addEventListener('click',()=>{ dlg.close(); cleanup(); }); dlg.showModal(); setTimeout(()=>{ document.getElementById('modalInput').focus(); },10); }

    // ---------- Auto-refresh simulation ----------
    function applyAutoRefresh(sec){ if(state.timers.refresh){ clearInterval(state.timers.refresh); state.timers.refresh=null; } if(!sec) return; state.timers.refresh=setInterval(()=>{ state.assets.forEach(a=>{ if(a.status==='retired') return; if(Math.random()<0.1) a.os=(Math.random()<0.7)?'up-to-date':'pending'; if(Math.random()<0.08) a.patch=(Math.random()<0.6)?'applied':'pending'; if(Math.random()<0.05) a.lastActive=daysAgo(randInt(0,120)); if(Math.random()<0.03&&a.status!=='up-for-replacement') a.status='up-for-replacement'; a.lastUpdated=nowISO(); }); render(); }, sec*1000); }

    // ---------- CSV Import ----------
    const REQUIRED_COLS = ['asset_id','type','status','patch_status','os_status','assigned_user','last_updated'];
    const OPTIONAL_COLS = ['department','device_age_months','last_os_update'];
    const VALID = {
      type: new Set(['laptop','mobile','tablet']),
      status: new Set(['provisioned','assigned','up-for-replacement','retired']),
      patch_status: new Set(['applied','pending']),
      os_status: new Set(['up-to-date','pending'])
    };

    const normalizeHeader = h=> h.trim().toLowerCase();

    // Robust CSV parser (handles quotes and CR/LF)
    function parseCSV(text){
      const rows=[]; let row=[]; let cur=''; let inQuotes=false; const pushCell=()=>{ row.push(cur); cur=''; };
      for(let i=0;i<text.length;i++){
        const ch=text[i]; const next=text[i+1];
        if(ch==='"'){
          if(inQuotes && next==='"'){ cur+='"'; i++; } else { inQuotes=!inQuotes; }
          continue;
        }
        if(!inQuotes && (ch===',' || ch==='\n' || ch==='\r')){
          if(ch===','){ pushCell(); continue; }
          // newline: finish cell & row (support CRLF)
          pushCell(); if(row.length){ rows.push(row); row=[]; }
          if(ch==='\r' && next==='\n') i++; // skip LF in CRLF
          continue;
        }
        cur+=ch;
      }
      // flush last cell/row
      if(cur.length>0 || row.length>0){ pushCell(); rows.push(row); }
      // remove empty trailing rows
      return rows.filter(r=> !(r.length===1 && r[0].trim()===''));
    }

    function parseDateLike(str){ if(!str) return null; let d=new Date(str); if(isNaN(d)){ const alt=str.replace(' ', 'T'); d=new Date(alt); } return isNaN(d)? null : d.toISOString(); }

    function showImportBanner(ok, skipped, errors){
      const banner=document.getElementById('importBanner'); const summary=document.getElementById('importSummary'); const list=document.getElementById('importErrorList');
      summary.textContent = `Imported ${ok} assets, skipped ${skipped} invalid row${skipped===1?'':'s'}.`;
      list.innerHTML='';
      if(skipped>0){ errors.forEach(e=>{ const li=document.createElement('li'); li.textContent=`Row ${e.row}: ${e.reason}`; list.appendChild(li); }); }
      banner.classList.remove('hidden');
    }

    function importCSV(text){
      const rows=parseCSV(text);
      if(rows.length===0){ showImportBanner(0,0,[{row:0,reason:'Empty CSV'}]); return; }
      const header=rows[0].map(normalizeHeader);
      const colIndex={}; header.forEach((h,i)=> colIndex[h]=i);
      const missing = REQUIRED_COLS.filter(h=> colIndex[h]===undefined);
      if(missing.length){ showImportBanner(0,0,[{row:0,reason:`Missing required columns: ${missing.join(', ')}`}]); return; }

      const errors=[]; const imported=[];
      for(let r=1;r<rows.length;r++){
        const row=rows[r]; const val=h=> (row[colIndex[h]] ?? '').trim();
        const asset_id=val('asset_id'); const type=val('type').toLowerCase(); const status=val('status').toLowerCase(); const patch_status=val('patch_status').toLowerCase(); const os_status=val('os_status').toLowerCase(); let assigned_user=val('assigned_user'); const last_updated_raw=val('last_updated');
        if(!asset_id||!type||!status||!patch_status||!os_status||!last_updated_raw){ errors.push({row:r+1,reason:'Missing required field'}); continue; }
        if(!VALID.type.has(type)){ errors.push({row:r+1,reason:`Invalid type: ${type}`}); continue; }
        if(!VALID.status.has(status)){ errors.push({row:r+1,reason:`Invalid status: ${status}`}); continue; }
        if(!VALID.patch_status.has(patch_status)){ errors.push({row:r+1,reason:`Invalid patch_status: ${patch_status}`}); continue; }
        if(!VALID.os_status.has(os_status)){ errors.push({row:r+1,reason:`Invalid os_status: ${os_status}`}); continue; }
        const last_updated=parseDateLike(last_updated_raw); if(!last_updated){ errors.push({row:r+1,reason:`Invalid last_updated: ${last_updated_raw}`}); continue; }
        const department = colIndex['department']!==undefined ? val('department') : undefined;
        const device_age_months_str = colIndex['device_age_months']!==undefined ? val('device_age_months') : undefined;
        const last_os_update_raw = colIndex['last_os_update']!==undefined ? val('last_os_update') : undefined;
        let device_age_months; if(device_age_months_str!==undefined && device_age_months_str!==''){ device_age_months=Number(device_age_months_str); if(Number.isNaN(device_age_months)){ errors.push({row:r+1,reason:`Non-numeric device_age_months: ${device_age_months_str}`}); continue; } }
        const last_os_update = last_os_update_raw? parseDateLike(last_os_update_raw) : undefined; if(last_os_update_raw && !last_os_update){ errors.push({row:r+1,reason:`Invalid last_os_update: ${last_os_update_raw}`}); continue; }
        if(!assigned_user){ assigned_user = 'unassigned'; }
        imported.push({ id:asset_id, type, status, patch:patch_status, os:os_status, user: assigned_user.toLowerCase()==='unassigned'? '' : assigned_user, lastUpdated:last_updated, lastActive:last_os_update||last_updated, ageDays: device_age_months!=null? Math.round(device_age_months*30): undefined, department });
      }
      if(imported.length===0){ showImportBanner(0,errors.length,errors.length? errors:[{row:0,reason:'No valid rows'}]); return; }
      state.assets=[...imported, ...state.assets];
      showImportBanner(imported.length, errors.length, errors);
      render();
    }

    // ---------- Tests (console) ----------
    function runCsvTests(){
      console.log('%cCSV parser tests','color:#22d3ee');
      const sample = `asset_id,type,status,patch_status,os_status,assigned_user,last_updated,department,device_age_months,last_os_update\n`+
        `LT-1029,laptop,assigned,pending,pending,ananya.rao,2025-09-24 09:42,Finance,28,2025-07-15\n`+
        `MB-3381,mobile,up-for-replacement,applied,up-to-date,unassigned,2025-09-24T09:45:00,Sales,42,2025-09-10\n`+
        `TB-2104,tablet,provisioned,applied,pending,unassigned,2025-09-24 09:50,Operations,6,2025-08-20`;
      const rows = parseCSV(sample);
      console.assert(rows.length===4,'Should parse header + 3 rows');
      const bad = `asset_id,type,status,patch_status,os_status,assigned_user,last_updated\n`+
                  `,laptop,assigned,applied,up-to-date,bad,2025-09-24`;
      const rows2 = parseCSV(bad); const header2 = rows2[0].map(normalizeHeader); const colIndex={}; header2.forEach((h,i)=> colIndex[h]=i);
      const v = (r,h)=> (rows2[r][colIndex[h]] ?? '').trim();
      console.assert(v(1,'asset_id')==='', 'Missing asset_id should be empty string');
      console.log('CSV tests complete.');
    }

    // ---------- Event wiring ----------
    function wireUI(){
      document.getElementById('addDemoBtn').addEventListener('click', ()=>{ const n=parseInt(document.getElementById('demoCount').value)||1; for(let i=0;i<n;i++) state.assets.unshift(randomAsset()); render(); });
      document.getElementById('refreshInterval').addEventListener('change', e=> applyAutoRefresh(parseInt(e.target.value)) );
      document.getElementById('search').addEventListener('input', e=>{ state.search=e.target.value; renderAssets(); });
      document.getElementById('filterStatus').addEventListener('change', e=>{ state.filterStatus=e.target.value; renderAssets(); });
      document.getElementById('filterType').addEventListener('change', e=>{ state.filterType=e.target.value; renderAssets(); });
      document.getElementById('regenAssist').addEventListener('click', renderAssistant);
      document.getElementById('exportBtn').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(state.assets,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='assets.json'; a.click(); URL.revokeObjectURL(url); });
      document.getElementById('uploadCsvBtn').addEventListener('click', ()=> document.getElementById('csvInput').click());
      document.getElementById('csvInput').addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; if(!f.name.toLowerCase().endsWith('.csv')){ showImportBanner(0,0,[{row:0,reason:'Please select a .csv file'}]); return; } const reader=new FileReader(); reader.onload=ev=> importCSV(ev.target.result); reader.readAsText(f); e.target.value=''; });
      document.getElementById('resetBtn').addEventListener('click', ()=>{ seedInitial(true); render(); showImportBanner(0,0,[{row:0,reason:'Data reset to default synthetic dataset'}]); });
      document.getElementById('dismissBanner').addEventListener('click', ()=> document.getElementById('importBanner').classList.add('hidden'));
      document.getElementById('runTestsBtn').addEventListener('click', runCsvTests);
    }

    // ---------- Seed & Init ----------
    function seedInitial(force=false){
      if(state.assets.length && !force) return;
      state.assets = [];
      for(let i=0;i<9;i++) state.assets.push(randomAsset());
      state.assets.push({ id:'AST-LAPTOP-001', type:'laptop', status:'assigned', patch:'pending', os:'pending', user:'meera.s', lastUpdated: daysAgo(10), lastActive: daysAgo(25), ageDays: 820 });
      state.assets.push({ id:'AST-PHONE-002', type:'mobile', status:'provisioned', patch:'applied', os:'up-to-date', user:'', lastUpdated: daysAgo(2), lastActive: daysAgo(65), ageDays: 400 });
      state.assets.push({ id:'AST-TAB-003', type:'tablet', status:'up-for-replacement', patch:'pending', os:'up-to-date', user:'alex.fernandez', lastUpdated: daysAgo(5), lastActive: daysAgo(3), ageDays: 1500 });
    }

    document.addEventListener('DOMContentLoaded', ()=>{ load(); seedInitial(); wireUI(); render(); });
      ul.innerHTML = '';
      const tpl = document.getElementById('alertItemTpl');
      alerts.forEach(al=>{
        const li = tpl.content.cloneNode(true);
        li.querySelector('p.text-sm').textContent = al.text;
        li.querySelector('p.text-xs').textContent = al.rationale;
        li.querySelector('button').addEventListener('click', ()=> al.resolve());
        ul.appendChild(li);
      });
    }

    // ---------- Smart Assistant ----------
    function renderAssistant(){
      const wrap = document.getElementById('assistant');
      wrap.innerHTML = '';

      const pendingOS = state.assets.filter(a=>a.os==='pending' && a.status!=='retired');
      const idle = state.assets.filter(a=>!a.user && a.status!=='retired' && (Date.now()-new Date(a.lastActive))/86400000>30);
      const replacements = state.assets.filter(a=>a.status==='up-for-replacement');

      const suggestions = [];
      if(pendingOS.length){
        suggestions.push({
          title: `Bulk update OS on ${pendingOS.length} device(s)`,
          detail: 'Bring all devices to up-to-date. Marks OS as updated and refreshes timestamps.',
          action: ()=>{ pendingOS.forEach(a=>{ a.os='up-to-date'; a.lastUpdated=nowISO(); }); render(); }
        });
      }
      if(idle.length){
        suggestions.push({
          title: `Review ${idle.length} idle unassigned device(s)`,
          detail: 'Assign to users or retire to reduce unused inventory.',
          action: ()=>{
            // Quick assign via prompt applied to all idle assets
            promptModal('Assign idle devices', 'Enter username to assign to all idle devices (leave empty to just update last active):', '', (val)=>{
              idle.forEach(a=>{
                if(val){ a.user = val; a.status='assigned'; a.lastActive=nowISO(); }
                else { a.lastActive = nowISO(); }
                a.lastUpdated=nowISO();
              });
              render();
            });
          }
        });
      }
      if(replacements.length){
        suggestions.push({
          title: `Schedule replacement for ${replacements.length} asset(s)`,
          detail: 'Moves flagged devices to retired state and clears assignments.',
          action: ()=>{ replacements.forEach(a=>{ a.status='retired'; a.user=''; a.lastUpdated=nowISO(); }); render(); }
        });
      }
      if(!suggestions.length){
        suggestions.push({ title:'All good!', detail:'No immediate actions suggested. Check again after the next refresh.' });
      }

      suggestions.forEach(s=>{
        const card = document.createElement('div');
        card.className = 'bg-slate-800/60 border border-slate-700 rounded-xl p-3';
        card.innerHTML = `
          <div class="font-medium">${s.title}</div>
          <div class="text-sm text-slate-400 mt-1">${s.detail}</div>
          ${s.action? '<div class="mt-2"><button class="px-3 py-1.5 text-xs rounded-lg bg-indigo-600 hover:bg-indigo-500">Apply</button></div>':''}
        `;
        if(s.action){ card.querySelector('button').addEventListener('click', s.action); }
        wrap.appendChild(card);
      });
    }

    // ---------- Utilities: Modal ----------
    function promptModal(title, label, value, onOk){
      const dlg = document.getElementById('modal');
      document.getElementById('modalTitle').textContent = title;
      const body = document.getElementById('modalBody');
      body.innerHTML = `
        <label class="block text-sm text-slate-300 mb-1">${label}</label>
        <input id="modalInput" value="${value||''}" class="w-full bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2 text-sm focus-ring" />`;
      const ok = document.getElementById('modalOk');
      const cancel = document.getElementById('modalCancel');
      const cleanup = ()=>{
        ok.replaceWith(ok.cloneNode(true)); // remove handlers
        cancel.replaceWith(cancel.cloneNode(true));
      }
      ok.addEventListener('click', ()=>{ const v = document.getElementById('modalInput').value.trim(); dlg.close(); cleanup(); onOk && onOk(v); });
      cancel.addEventListener('click', ()=>{ dlg.close(); cleanup(); });
      dlg.showModal();
      setTimeout(()=>{ document.getElementById('modalInput').focus(); }, 10);
    }

    // ---------- Auto-refresh simulation ----------
    function applyAutoRefresh(sec){
      if(state.timers.refresh){ clearInterval(state.timers.refresh); state.timers.refresh=null; }
      if(!sec) return;
      state.timers.refresh = setInterval(()=>{
        // Randomly drift some statuses to simulate updates
        state.assets.forEach(a=>{
          if(a.status==='retired') return;
          if(Math.random()<0.1) a.os = (Math.random()<0.7)? 'up-to-date':'pending';
          if(Math.random()<0.08) a.patch = (Math.random()<0.6)? 'applied':'pending';
          if(Math.random()<0.05) a.lastActive = daysAgo(randInt(0,120));
          if(Math.random()<0.03 && a.status!=='up-for-replacement') a.status = 'up-for-replacement';
          a.lastUpdated = nowISO();
        });
        render();
      }, sec*1000);
    }

    // ---------- Event wiring ----------
    function wireUI(){
      document.getElementById('addDemoBtn').addEventListener('click', ()=>{
        const n = parseInt(document.getElementById('demoCount').value)||1;
        for(let i=0;i<n;i++) state.assets.unshift(randomAsset());
        render();
      });
      document.getElementById('refreshInterval').addEventListener('change', (e)=>{
        const sec = parseInt(e.target.value);
        applyAutoRefresh(sec);
      });
      document.getElementById('search').addEventListener('input', (e)=>{ state.search = e.target.value; renderAssets(); });
      document.getElementById('filterStatus').addEventListener('change', (e)=>{ state.filterStatus = e.target.value; renderAssets(); });
      document.getElementById('filterType').addEventListener('change', (e)=>{ state.filterType = e.target.value; renderAssets(); });
      document.getElementById('regenAssist').addEventListener('click', renderAssistant);
      document.getElementById('exportBtn').addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify(state.assets, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'assets.json'; a.click(); URL.revokeObjectURL(url);
      });
      // CSV upload
      document.getElementById('uploadCsvBtn').addEventListener('click', ()=> document.getElementById('csvInput').click());
      document.getElementById('csvInput').addEventListener('change', (e)=>{
        const file = e.target.files[0]; if(!file) return;
        if(!file.name.toLowerCase().endsWith('.csv')){ showImportBanner(0,0,[{row:0,reason:'Please select a .csv file'}]); return; }
        const reader = new FileReader();
        reader.onload = (ev)=> importCSV(ev.target.result);
        reader.readAsText(file);
        e.target.value = '';
      });
      // Reset
      document.getElementById('resetBtn').addEventListener('click', ()=>{ seedInitial(true); render(); showImportBanner(0,0,[{row:0,reason:'Data reset to default synthetic dataset'}]); });
      // Dismiss banner
      document.getElementById('dismissBanner').addEventListener('click', ()=>{ document.getElementById('importBanner').classList.add('hidden'); });
    });
      document.getElementById('refreshInterval').addEventListener('change', (e)=>{
        const sec = parseInt(e.target.value);
        applyAutoRefresh(sec);
      });
      document.getElementById('search').addEventListener('input', (e)=>{ state.search = e.target.value; renderAssets(); });
      document.getElementById('filterStatus').addEventListener('change', (e)=>{ state.filterStatus = e.target.value; renderAssets(); });
      document.getElementById('filterType').addEventListener('change', (e)=>{ state.filterType = e.target.value; renderAssets(); });
      document.getElementById('regenAssist').addEventListener('click', renderAssistant);
      document.getElementById('exportBtn').addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify(state.assets, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'assets.json'; a.click(); URL.revokeObjectURL(url);
      });
    }

    // ---------- Init ----------
    function seedInitial(force=false){
      if(state.assets.length && !force) return;
      state.assets = [];
      for(let i=0;i<9;i++){ state.assets.push(randomAsset()); }
      state.assets.push({ id: 'AST-LAPTOP-001', type:'laptop', status:'assigned', patch:'pending', os:'pending', user:'meera.s', lastUpdated: daysAgo(10), lastActive: daysAgo(25), ageDays: 820 });
      state.assets.push({ id: 'AST-PHONE-002', type:'mobile', status:'provisioned', patch:'applied', os:'up-to-date', user:'', lastUpdated: daysAgo(2), lastActive: daysAgo(65), ageDays: 400 });
      state.assets.push({ id: 'AST-TAB-003', type:'tablet', status:'up-for-replacement', patch:'pending', os:'up-to-date', user:'alex.fernandez', lastUpdated: daysAgo(5), lastActive: daysAgo(3), ageDays: 1500 });
    }
      // Ensure a few deterministics
      state.assets.push({ id: 'AST-LAPTOP-001', type:'laptop', status:'assigned', patch:'pending', os:'pending', user:'meera.s', lastUpdated: daysAgo(10), lastActive: daysAgo(25), ageDays: 820 });
      state.assets.push({ id: 'AST-PHONE-002', type:'mobile', status:'provisioned', patch:'applied', os:'up-to-date', user:'', lastUpdated: day